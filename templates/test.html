<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>xobi Image Translator 😈</title>
    <!-- 引入fabric.js库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <!-- Google Fonts: Varela Round (Rounded/Cute) -->
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/main.css?v=50-Magnifier">
    <!-- 引入JSZip用于批量打包下载 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>

<body>
    <!-- 移动端抽屉遮罩 -->
    <div class="drawer-overlay" id="drawer-overlay"></div>
    <!-- 顶部导航栏 -->
    <header class="top-header">
        <div class="header-left">
            <div class="logo">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="url(#logo-grad)" stroke-width="2">
                    <defs>
                        <linearGradient id="logo-grad" x1="0" y1="0" x2="1" y2="1">
                            <stop offset="0%" stop-color="#0A84FF" />
                            <stop offset="100%" stop-color="#007AFF" />
                        </linearGradient>
                    </defs>
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                </svg>
                <a class="nav-brand" href="/">
                    <span class="logo-text">Xobi Trans</span><span class="logo-emoji">💀</span>
                </a>
            </div>
        </div>
        <div class="header-center">
            <!-- 步骤流程 (默认显示) -->
            <div class="workflow-steps" id="workflow-steps">
                <div class="step active">
                    <span class="step-num">1</span>
                    <span class="step-text">上传图片 📸</span>
                </div>
                <div class="step-arrow">→</div>
                <div class="step">
                    <span class="step-num">2</span>
                    <span class="step-text">智能翻译 ✨</span>
                </div>
                <div class="step-arrow">→</div>
                <div class="step">
                    <span class="step-num">3</span>
                    <span class="step-text">编辑下载 🎀</span>
                </div>
            </div>

            <!-- 矩形属性面板 (选中矩形时显示) -->
            <div class="rect-properties-panel" id="rect-properties-panel" style="display: none;">
                <span class="rect-panel-title">□ 矩形样式</span>
                <div class="rect-prop-group">
                    <label>填充</label>
                    <input type="color" id="rect-fill-color" value="#000000">
                </div>
                <div class="rect-prop-group">
                    <label>描边</label>
                    <input type="color" id="rect-stroke-color" value="#ffffff">
                </div>
                <div class="rect-prop-group">
                    <label>边宽</label>
                    <input type="range" id="rect-stroke-width" min="0" max="10" value="0" style="width: 60px;">
                    <span id="rect-stroke-width-val">0</span>
                </div>
                <div class="rect-prop-group">
                    <label>圆角</label>
                    <input type="range" id="rect-corner-radius" min="0" max="50" value="0" style="width: 60px;">
                    <span id="rect-corner-radius-val">0</span>
                </div>
            </div>
        </div>
        <div class="header-right">
            <!-- 药丸型主题切换器 -->
            <div class="theme-pill" id="theme-toggle" title="切换主题">
                <div class="theme-pill-indicator"></div>
                <span class="theme-pill-icon" data-theme="light">☀️</span>
                <span class="theme-pill-icon" data-theme="dark">🌙</span>
            </div>
            <button class="header-btn" id="sync-settings-btn" title="同步到文件夹">
                <span style="font-size: 20px;">📂</span>
            </button>
            <button class="header-btn" id="help-btn" title="使用帮助">
                <span style="font-size: 20px;">📖</span>
            </button>
            <button class="header-btn danger" id="clear-cache-btn" title="清除缓存">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
            </button>
        </div>
    </header>

    <!-- 主体区域 - 3栏布局 -->
    <main class="main-container">
        <!-- 左侧面板 - 样式类名更新 -->
        <aside class="aside-panel left-side">
            <div class="left-panel-scroll-content">

                <!-- 上传图片 - 移至顶部 (用户请求) -->
                <div class="panel-card">
                    <div class="card-header">
                        <span>上传图片 🍬</span>
                    </div>
                    <div class="card-body">
                        <form id="uploadForm" enctype="multipart/form-data" method="post" action="/process_image">
                            <!-- 使用 label 替代 div，原生关联 input，无需JS，彻底解决点击死循环 -->
                            <div class="upload-zone-wrapper">
                                <input type="file" id="multi-image-upload" name="image" accept="image/*" multiple
                                    style="display: none;">
                                <label class="upload-zone compact-zone" for="multi-image-upload" id="uploadZone">
                                    <div class="upload-content">
                                        <div class="upload-icon-large compact-icon">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                                <polyline points="17 8 12 3 7 8"></polyline>
                                                <line x1="12" y1="3" x2="12" y2="15"></line>
                                            </svg>
                                        </div>
                                        <p class="upload-text compact-text">点击 / 拖拽上传</p>
                                        <p id="file-count-preview"
                                            style="font-size: 11px; color: var(--accent); margin-top: 4px; display: none;">
                                        </p>
                                    </div>
                                </label>
                            </div>
                        </form>
                        <div id="uploadStatus" class="status-msg"></div>
                    </div>
                </div>

                <div class="panel-card">
                    <div class="card-header">
                        <span>语言设置 🌐</span>
                    </div>
                    <div class="card-body">
                        <div class="lang-group">
                            <label>源语言</label>
                            <select id="source-lang">
                                <option value="auto">🔍 自动检测</option>
                                <option value="zh" selected>🇨🇳 中文</option>
                                <option value="en">🇺🇸 英文</option>
                                <option value="ja">🇯🇵 日文</option>
                                <option value="ko">🇰🇷 韩文</option>
                            </select>
                        </div>

                        <div class="lang-group">
                            <label>目标语言 <small>(可多选)</small></label>
                            <div id="target-langs-container" class="lang-grid">
                                <label class="lang-checkbox">
                                    <input type="checkbox" name="target-lang" value="en" checked>
                                    <span class="checkbox-label">🇺🇸 英语</span>
                                </label>
                                <label class="lang-checkbox">
                                    <input type="checkbox" name="target-lang" value="th">
                                    <span class="checkbox-label">🇹🇭 泰语</span>
                                </label>
                                <label class="lang-checkbox">
                                    <input type="checkbox" name="target-lang" value="id">
                                    <span class="checkbox-label">🇮🇩 印尼语</span>
                                </label>
                                <label class="lang-checkbox">
                                    <input type="checkbox" name="target-lang" value="vi">
                                    <span class="checkbox-label">🇻🇳 越南语</span>
                                </label>
                                <label class="lang-checkbox">
                                    <input type="checkbox" name="target-lang" value="ru">
                                    <span class="checkbox-label">🇷🇺 俄语</span>
                                </label>
                                <label class="lang-checkbox">
                                    <input type="checkbox" name="target-lang" value="ja">
                                    <span class="checkbox-label">🇯🇵 日语</span>
                                </label>
                                <label class="lang-checkbox">
                                    <input type="checkbox" name="target-lang" value="ko">
                                    <span class="checkbox-label">🇰🇷 韩语</span>
                                </label>
                                <label class="lang-checkbox">
                                    <input type="checkbox" name="target-lang" value="zh">
                                    <span class="checkbox-label">🇨🇳 中文</span>
                                </label>
                                <label class="lang-checkbox">
                                    <input type="checkbox" name="target-lang" value="fr">
                                    <span class="checkbox-label">🇫🇷 法语</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 背景处理模型选择 -->
                <div class="panel-card">
                    <div class="card-header">
                        <span>背景处理 🎨</span>
                        <!-- 纯色背景勾选框 -->
                        <!-- 智能背景勾选框 -->
                        <label class="solid-bg-toggle" title="智能识别背景类型：纯色背景直接填充（更快更干净），复杂背景使用AI修复"
                            style="margin-right: 15px;">
                            <input type="checkbox" id="smart-bg-mode" name="smart-bg-mode" checked>
                            <span class="solid-bg-checkbox" style="border-color: #3b82f6;"></span>
                            <span class="solid-bg-label">⚡ 智能背景</span>
                        </label>

                        <!-- 纯色背景勾选框 -->
                        <label class="solid-bg-toggle" title="勾选后使用纯色矩形覆盖文字，适合纯色背景图片">
                            <input type="checkbox" id="solid-bg-mode" name="solid-bg-mode">
                            <span class="solid-bg-checkbox"></span>
                            <span class="solid-bg-label">全部纯色</span>
                        </label>
                    </div>
                    <div class="card-body">
                        <div class="model-selector" id="bg-model-selector">
                            <label class="model-option">
                                <input type="radio" name="bg-model" value="opencv" checked>
                                <span class="model-label">
                                    <span class="model-name">OpenCV</span>
                                    <span class="model-desc">最快 · 基础修复</span>
                                </span>
                            </label>
                            <label class="model-option">
                                <input type="radio" name="bg-model" value="lama">
                                <span class="model-label">
                                    <span class="model-name">LaMa ⚡</span>
                                    <span class="model-desc">快速 · AI文字擦除</span>
                                </span>
                            </label>
                            <label class="model-option">
                                <input type="radio" name="bg-model" value="iop">
                                <span class="model-label">
                                    <span class="model-name">PowerPaint</span>
                                    <span class="model-desc">精准 · 较慢</span>
                                </span>
                            </label>
                        </div>
                        <!-- 纯色背景模式提示 -->
                        <div id="solid-bg-hint" class="solid-bg-hint" style="display: none;">
                            <span>🎨 将提取边框颜色并用纯色矩形覆盖文字</span>
                        </div>
                    </div>
                </div>



                <!-- 翻译按钮 - 放在底部 -->
                <!-- 🔑 注意：onclick已移除！事件由JS处理，避免双重调用 -->
            </div>
            <div class="left-panel-footer">
                <button id="translate-button" class="action-btn primary"
                    style="width: 100%; cursor: pointer !important; pointer-events: auto !important;">
                    <span>⚡ 开始翻译 GO!</span>
                </button>

                <!-- 批处理进度条 (translateImage函数需要) -->
                <div id="batch-progress" style="display: none; margin-top: 10px;">
                    <div class="progress-bar-bg"
                        style="background: rgba(255,255,255,0.1); border-radius: 99px; height: 8px; overflow: hidden;">
                        <div id="batch-progress-bar"
                            style="width: 0%; height: 100%; background: var(--success); transition: width 0.3s;"></div>
                    </div>
                    <div id="batch-status-text"
                        style="text-align: center; font-size: 12px; margin-top: 5px; color: var(--text-secondary);">
                        准备中...
                    </div>
                </div>
            </div>
        </aside>

        <!-- 中心工作区 -->
        <section class="center-workspace">
            <div class="workspace-header">
                <div class="view-tabs">
                    <button class="view-tab active" data-view="split">并排对比</button>
                    <button class="view-tab" data-view="overlay">叠加对比</button>
                </div>
                <div class="zoom-controls">
                    <button class="zoom-btn" id="zoomOut">−</button>
                    <span class="zoom-level" id="zoomLevel">100%</span>
                    <button class="zoom-btn" id="zoomIn">+</button>
                    <button class="zoom-btn" id="zoomFit">适应</button>
                </div>
                <!-- 🔑 撤销/重做按钮 -->
                <div class="history-controls">
                    <button class="history-btn" id="undoBtn" title="撤销 (Ctrl+Z)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <path d="M3 7v6h6"></path>
                            <path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path>
                        </svg>
                    </button>
                    <button class="history-btn" id="redoBtn" title="重做 (Ctrl+Shift+Z)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <path d="M21 7v6h-6"></path>
                            <path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 2.7"></path>
                        </svg>
                    </button>
                </div>
                <!-- 🔑 添加矩形和文本按钮 -->
                <button id="add-rect-btn" class="view-tab tool-btn-accent" style="margin-left: auto;">
                    <span style="font-size: 12px;">◻️</span> 矩形
                </button>
                <!-- 🔑 画笔工具 -->
                <div class="brush-tool-container">
                    <button id="brush-btn" class="view-tab tool-btn-accent" title="画笔工具 - 用于手动修补瑕疵">
                        <span style="font-size: 12px;">🖌️</span> 画笔
                    </button>
                    <!-- 画笔设置面板 -->
                    <div id="brush-panel" class="brush-settings-panel" style="display: none;">
                        <div class="brush-panel-header">
                            <span>🎨 画笔设置</span>
                            <button id="brush-panel-close" class="brush-close-btn">×</button>
                        </div>
                        <div class="brush-panel-body">
                            <!-- 颜色选择 -->
                            <div class="brush-setting-row">
                                <label>颜色</label>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="color" id="brush-color" value="#000000"
                                        style="width: 36px; height: 28px;">
                                    <span id="brush-color-hex"
                                        style="font-size: 11px; color: var(--text-secondary);">#000000</span>
                                    <button id="eyedropper-btn" class="style-btn" title="吸色工具"
                                        style="padding: 4px 8px;">
                                        💧
                                    </button>
                                </div>
                            </div>
                            <!-- 画笔粗细 -->
                            <div class="brush-setting-row">
                                <label>粗细</label>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="range" id="brush-size" min="1" max="50" value="10" style="flex: 1;">
                                    <span id="brush-size-value" style="min-width: 30px; font-size: 12px;">10px</span>
                                </div>
                            </div>
                            <!-- 快捷粗细 -->
                            <div class="brush-setting-row">
                                <div style="display: flex; gap: 6px;">
                                    <button class="brush-size-preset" data-size="3">细</button>
                                    <button class="brush-size-preset active" data-size="10">中</button>
                                    <button class="brush-size-preset" data-size="25">粗</button>
                                    <button class="brush-size-preset" data-size="50">超粗</button>
                                </div>
                            </div>
                            <!-- 状态提示 -->
                            <div id="brush-status" class="brush-status">
                                点击画布开始绘制
                            </div>
                        </div>
                    </div>
                </div>
                <button id="add-text-btn-top" class="view-tab tool-btn-accent">
                    <span style="font-size: 12px;">✏️</span> 文本
                </button>
            </div>

            <div class="preview-container">
                <div class="image-panel original-panel">
                    <div class="panel-label">🖼️ 原图</div>
                    <div class="empty-placeholder" id="original-empty">
                        <span class="emoji">📷</span>
                        <span class="text">请在左侧上传图片</span>
                    </div>
                    <div class="image-wrapper">
                        <img id="original-preview" class="preview-image" src="" alt="原始图片" style="display: none;">
                    </div>
                </div>
                <div class="image-panel result-panel">
                    <div class="panel-label">✨ 翻译结果</div>
                    <div class="empty-placeholder" id="result-empty">
                        <span class="emoji">🎨</span>
                        <span class="text">翻译结果将显示在这里</span>
                    </div>
                    <div class="image-wrapper">
                        <div id="fabricCanvasContainer" style="position: relative;">
                            <!-- 视觉缓冲画布 (防止Undo闪烁) -->
                            <canvas id="snapshotCanvas"
                                style="position: absolute; top: 0; left: 0; pointer-events: none; display: none; z-index: 999;"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 🔑 居中加载遮罩 (移动到两个面板之间) -->
                <div class="loading-overlay" id="loadingOverlay">
                    <div class="loading-content">
                        <div class="loading-percent" id="loadingPercent">0%</div>
                        <div class="loading-text" id="loadingText">正在处理图片...</div>
                        <div class="progress-container">
                            <div class="progress-bar-fill" id="progressBarFill"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 语言版本标签栏 -->
            <div class="lang-tabs-container" id="langTabsContainer" style="display: none;">
                <div class="lang-tabs" id="langTabs">
                    <!-- 标签会由JS动态生成 -->
                </div>
            </div>

            <!-- 底部缩略图条 -->
            <div class="thumbnail-bar" id="thumbnailArea">
                <div class="thumbnail-placeholder">上传图片后，缩略图将显示在这里</div>
            </div>
        </section>

        <!-- 右侧面板 - 编辑器 -->
        <aside class="aside-panel right-side">
            <div class="right-side-scroll-wrapper">
                <!-- 文字样式编辑器 -->
                <div class="panel-card" id="text-style-editor" style="display: none;">
                    <div class="card-header">
                        <span class="style-header">文字编辑 ✏️</span>
                    </div>
                    <div class="card-body" style="padding: 12px;">
                        <!-- 字体 + 渲染模式 -->
                        <div class="edit-group">
                            <div style="display: flex; gap: 8px;">
                                <div style="flex: 2;">
                                    <label>字体</label>
                                    <select id="font-family" class="font-select" style="height: 32px; font-size: 12px;">
                                        <option value="Arial, sans-serif">Arial</option>
                                        <option value="'Microsoft YaHei', sans-serif">微软雅黑</option>
                                        <option value="SimHei, sans-serif">黑体</option>
                                        <option value="SimSun, serif">宋体</option>
                                        <option value="KaiTi, serif">楷体</option>
                                        <option value="'Noto Sans SC', sans-serif">Noto Sans SC</option>
                                        <option value="'PingFang SC', sans-serif">苹方</option>
                                        <option value="Georgia, serif">Georgia</option>
                                        <option value="'Times New Roman', serif">Times New Roman</option>
                                    </select>
                                </div>
                                <div style="flex: 1;">
                                    <label>渲染</label>
                                    <select id="text-render-mode" class="font-select"
                                        style="height: 32px; font-size: 11px;">
                                        <option value="default">默认</option>
                                        <option value="sharp" selected>锐利</option>
                                        <option value="strong">浑厚</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- 字号 -->
                        <div class="edit-group">
                            <label>字号</label>
                            <div class="slider-row">
                                <input type="range" id="font-size" min="8" max="120" value="20">
                                <input type="number" id="font-size-input" class="size-input" value="20" min="8"
                                    max="200" style="width: 50px; height: 32px;">
                                <span class="size-unit">px</span>
                            </div>
                            <div style="display: flex; gap: 6px; margin-top: 8px;">
                                <button class="style-btn size-shortcut-btn" data-size="24" style="flex: 1;">24</button>
                                <button class="style-btn size-shortcut-btn active" data-size="35"
                                    style="flex: 1;">35</button>
                                <button class="style-btn size-shortcut-btn" data-size="48" style="flex: 1;">48</button>
                                <button class="style-btn size-shortcut-btn" data-size="64" style="flex: 1;">64</button>
                            </div>
                        </div>

                        <!-- 样式 + 颜色 -->
                        <div class="edit-group">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="flex: 1;">
                                    <label>颜色</label>
                                    <div class="color-row">
                                        <input type="color" id="text-color" value="#000000"
                                            style="width: 40px; height: 32px;">
                                        <span id="text-color-hex" class="color-hex"
                                            style="font-size: 11px;">#000000</span>
                                    </div>
                                </div>
                                <div>
                                    <label>样式</label>
                                    <div class="btn-group style-buttons">
                                        <button id="toggle-bold" class="style-btn"
                                            title="粗体"><strong>B</strong></button>
                                        <button id="toggle-italic" class="style-btn" title="斜体"><em>I</em></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 文字转换 (Capitalize/Uppercase) -->
                        <div class="edit-group">
                            <label>排版样式</label>
                            <div class="btn-group" style="width: 100%;">
                                <button id="text-transform-capitalize" class="style-btn" title="首字母大写"
                                    style="flex: 1;">Aa</button>
                                <button id="text-transform-uppercase" class="style-btn" title="全部大写"
                                    style="flex: 1;">AA</button>
                                <button id="text-transform-none" class="style-btn" title="清除格式"
                                    style="flex: 1;">ab</button>
                            </div>
                        </div>

                        <!-- 文字阴影 (简化版) -->
                        <div class="edit-group">
                            <label>文字阴影</label>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="color" id="shadow-color" value="#000000"
                                    style="width: 32px; height: 32px; flex-shrink: 0;" title="阴影颜色">
                                <div style="display: flex; flex: 1; gap: 4px; font-size: 10px;">
                                    <div style="display: flex; align-items: center; gap: 2px;">
                                        <span style="color: var(--text-muted);">X</span>
                                        <input type="number" id="shadow-offset-x" value="2" min="-20" max="20"
                                            class="size-input" style="width: 36px; height: 24px;">
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 2px;">
                                        <span style="color: var(--text-muted);">Y</span>
                                        <input type="number" id="shadow-offset-y" value="2" min="-20" max="20"
                                            class="size-input" style="width: 36px; height: 24px;">
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 2px;">
                                        <span style="color: var(--text-muted);">B</span>
                                        <input type="number" id="shadow-blur" value="4" min="0" max="30"
                                            class="size-input" style="width: 36px; height: 24px;">
                                    </div>
                                </div>
                                <button id="toggle-shadow" class="style-btn" title="开关阴影"
                                    style="width: 28px; height: 28px; flex-shrink: 0; font-size: 12px;">×</button>
                            </div>
                        </div>

                        <!-- 描边 -->
                        <div class="edit-group">
                            <label>描边</label>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="color" id="stroke-color" value="#FFFFFF"
                                    style="width: 36px; height: 32px;">
                                <input type="range" id="stroke-width" min="0" max="10" value="0" style="flex: 1;">
                                <span id="stroke-width-value" class="slider-value">0px</span>
                            </div>
                        </div>

                        <!-- 字间距 / 行高 -->
                        <div style="display: flex; gap: 8px;">
                            <div class="edit-group" style="flex: 1;">
                                <label>字间距</label>
                                <div style="display: flex; gap: 4px;">
                                    <input type="number" id="letter-spacing-input" class="size-input" value="0" step="5"
                                        style="width: 100%; height: 32px;">
                                </div>
                            </div>
                            <div class="edit-group" style="flex: 1;">
                                <label>行高</label>
                                <div style="display: flex; gap: 4px;">
                                    <input type="number" id="line-height-input" class="size-input" value="0.8"
                                        step="0.1" style="width: 100%; height: 32px;">
                                </div>
                            </div>
                        </div>

                        <!-- 文本内对齐 -->
                        <div class="edit-group">
                            <label>文本对齐</label>
                            <div class="btn-group align-buttons">
                                <button class="style-btn align-btn" data-align="left" title="左对齐" style="flex: 1;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="4" y1="6" x2="20" y2="6"></line>
                                        <line x1="4" y1="12" x2="14" y2="12"></line>
                                        <line x1="4" y1="18" x2="18" y2="18"></line>
                                    </svg>
                                </button>
                                <button class="style-btn align-btn active" data-align="center" title="居中"
                                    style="flex: 1;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="4" y1="6" x2="20" y2="6"></line>
                                        <line x1="8" y1="12" x2="16" y2="12"></line>
                                        <line x1="6" y1="18" x2="18" y2="18"></line>
                                    </svg>
                                </button>
                                <button class="style-btn align-btn" data-align="right" title="右对齐" style="flex: 1;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="4" y1="6" x2="20" y2="6"></line>
                                        <line x1="10" y1="12" x2="20" y2="12"></line>
                                        <line x1="6" y1="18" x2="20" y2="18"></line>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- 画布对齐 (PS式) -->
                        <div class="edit-group">
                            <label>画布对齐</label>
                            <div class="canvas-align-row"
                                style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px;">
                                <button class="align-canvas-btn" id="align-h-left" title="左对齐"><svg
                                        xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="4" y1="4" x2="4" y2="20"></line>
                                        <rect x="8" y="8" width="12" height="8" rx="1"></rect>
                                    </svg></button>
                                <button class="align-canvas-btn" id="align-h-center" title="居中"><svg
                                        xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="12" y1="4" x2="12" y2="20"></line>
                                        <rect x="6" y="8" width="10" height="8" rx="1"></rect>
                                    </svg></button>
                                <button class="align-canvas-btn" id="align-h-right" title="右对齐"><svg
                                        xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="20" y1="4" x2="20" y2="20"></line>
                                        <rect x="4" y="8" width="12" height="8" rx="1"></rect>
                                    </svg></button>
                                <button class="align-canvas-btn" id="align-v-top" title="顶对齐"><svg
                                        xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="4" y1="4" x2="20" y2="4"></line>
                                        <rect x="8" y="8" width="8" height="12" rx="1"></rect>
                                    </svg></button>
                                <button class="align-canvas-btn" id="align-v-center" title="垂直居中"><svg
                                        xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="4" y1="12" x2="20" y2="12"></line>
                                        <rect x="8" y="6" width="8" height="10" rx="1"></rect>
                                    </svg></button>
                                <button class="align-canvas-btn" id="align-v-bottom" title="底对齐"><svg
                                        xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="4" y1="20" x2="20" y2="20"></line>
                                        <rect x="8" y="4" width="8" height="12" rx="1"></rect>
                                    </svg></button>
                            </div>
                        </div>

                        <!-- 多选工具 -->
                        <div class="edit-group" id="multi-select-tools" style="display: none;">
                            <label>多选工具</label>
                            <div style="display: flex; gap: 8px;">
                                <button class="tool-btn-wide" id="uniform-width" style="flex: 1;">统一宽度</button>
                                <button class="tool-btn-wide" id="distribute-v" style="flex: 1;">垂直均分</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 固定在底部的下载按钮 -->
            <div class="right-side-footer">
                <div class="panel-card" id="download-panel"
                    style="margin-bottom: 0; background: transparent; border: none; box-shadow: none;">
                    <div class="card-body" style="padding: 0;">

                        <!-- 🔑 快捷同步按钮（翻译后才显示） -->
                        <div id="quick-sync-section" style="margin-bottom: 8px; display: none;">
                            <button class="action-btn primary" id="quick-sync-all-btn"
                                style="width: 100%; height: 38px;" onclick="quickSyncAll()">
                                🚀 一键同步到文件夹
                            </button>
                        </div>

                        <!-- 🔑 历史记录折叠区（始终显示） -->
                        <details id="quick-history-details" class="history-details-box">
                            <summary class="history-summary">
                                <span style="flex: 1;">📜 翻译历史</span>
                                <button class="style-btn danger" title="清空所有历史"
                                    style="font-size: 12px; padding: 2px 6px;"
                                    onclick="event.stopPropagation(); clearAllSyncHistory();">
                                    🗑️
                                </button>
                            </summary>
                            <div id="quick-history-list"
                                style="max-height: 150px; overflow-y: auto; padding: 0 12px 8px;">
                                <!-- 历史记录由JS动态生成 -->
                            </div>
                        </details>

                        <button class="action-btn success" id="save-image" onclick="downloadImage()"
                            style="width: 100%; height: 44px; margin-bottom: 10px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            <span>📥 保存当前结果</span>
                        </button>
                        <button class="action-btn primary" id="download-all-btn" onclick="downloadAllImages()"
                            style="width: 100%; height: 44px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            <span>📦 批量打包下载</span>
                        </button>

                        <div id="multi-lang-downloads" style="margin-top: 12px; display: none;">
                            <div
                                style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px; text-align: center;">
                                分语言导出</div>
                            <div id="lang-download-btns" style="display: flex; flex-direction: column; gap: 6px;"></div>
                        </div>

                        <!-- 同步提示 -->
                        <div id="sync-buttons-container"
                            style="margin-top: 15px; padding-top: 15px; border-top: 1px dashed var(--border); display: none;">
                            <button id="sync-current-btn" class="style-btn" onclick="syncStylesToAllLangs()"
                                style="width: 100%; margin-bottom: 6px; font-size: 12px; height: 32px;">🔄
                                同步样式到当前图所有语言</button>
                            <button id="sync-all-everything-btn" class="style-btn" onclick="syncStylesToEverything()"
                                style="width: 100%; font-size: 12px; height: 32px;">🌍 全局同步（所有图+所有语言）</button>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
    </main>

    <!-- 帮助模态框 -->
    <div class="help-modal" id="helpModal">
        <div class="help-modal-content">
            <div class="help-modal-header">
                <h3>📖 使用指南</h3>
                <button class="help-close-btn" id="help-close">&times;</button>
            </div>
            <div class="help-modal-body">
                <div class="help-step">
                    <span class="help-num">1</span>
                    <div class="help-text">
                        <strong>选择语言</strong>
                        <p>在左侧面板选择源语言和目标语言</p>
                    </div>
                </div>
                <div class="help-step">
                    <span class="help-num">2</span>
                    <div class="help-text">
                        <strong>上传图片</strong>
                        <p>点击上传区域或拖拽图片到上传区</p>
                    </div>
                </div>
                <div class="help-step">
                    <span class="help-num">3</span>
                    <div class="help-text">
                        <strong>开始翻译</strong>
                        <p>点击"开始翻译"按钮进行AI翻译</p>
                    </div>
                </div>
                <div class="help-step">
                    <span class="help-num">4</span>
                    <div class="help-text">
                        <strong>编辑文字</strong>
                        <p>点击画布中的文字可编辑样式、字体、颜色</p>
                    </div>
                </div>
                <div class="help-step">
                    <span class="help-num">5</span>
                    <div class="help-text">
                        <strong>下载结果</strong>
                        <p>编辑完成后点击保存或批量下载</p>
                    </div>
                </div>
                <div class="help-shortcuts">
                    <h4>⌨️ 快捷键</h4>
                    <div class="shortcut-list">
                        <div><kbd>Ctrl</kbd>+<kbd>Z</kbd> 撤销</div>
                        <div><kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>Z</kbd> 重做</div>
                        <div><kbd>Delete</kbd> 删除选中</div>
                        <div><kbd>Ctrl</kbd>+<kbd>A</kbd> 全选</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 同步到文件夹模态框 -->
    <div class="sync-modal" id="syncModal">
        <div class="sync-modal-content">
            <div class="sync-modal-header">
                <h3>📂 同步到文件夹</h3>
                <button class="sync-close-btn" id="sync-close">&times;</button>
            </div>
            <div class="sync-modal-body">
                <div class="sync-description">
                    配置各语言的目标文件夹路径，翻译完成后可一键同步替换。<br>
                    <small>💡 点击输入框右侧的文件夹图标可快速选择路径</small>
                </div>
                <div id="sync-lang-paths">
                    <!-- 语言路径配置将由 JS 动态生成 -->
                    <div class="sync-empty-hint" id="sync-empty-hint">
                        <span style="font-size: 32px;">🌐</span>
                        <p>请先翻译图片，然后在这里配置各语言的目标文件夹</p>
                    </div>
                </div>
                <div class="sync-actions">
                    <button class="action-btn primary" id="sync-all-btn">
                        🚀 一键同步全部
                    </button>
                    <button class="action-btn secondary" id="sync-history-btn" title="历史记录"
                        onclick="toggleHistoryPanel()">
                        📜
                    </button>
                </div>
                <div id="sync-status" class="sync-status" style="display: none;"></div>

                <!-- 历史记录面板 -->
                <div id="sync-history-panel" class="sync-history-panel" style="display: none;">
                    <div class="sync-history-header">
                        <span>📜 同步历史记录</span>
                        <button class="sync-close-btn" onclick="toggleHistoryPanel()">&times;</button>
                    </div>
                    <div id="sync-history-list" class="sync-history-list">
                        <!-- 历史记录列表将由 JS 动态生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 历史提示元素 -->
    <div class="history-tooltip" id="historyTooltip"></div>

    <script src="/static/js/app.js?v=2024-12-24-v78-PartialEraser"></script>
</body>

</html>